<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{articleSingle.title}} - {{& OPT.siteName}}</title>
    <meta name="description" content="{{articleSingle.contentText}}">
    <meta name="keywords" content="{{articleSingle.tags}}">
    <link rel="stylesheet" href="{{& OPT.theme_github_path}}JustNews/files/style.css">
    <link rel="stylesheet" href="{{& OPT.theme_github_path}}JustNews/files/fonts/fontawesome5pro-all.min.css">
	<link rel="stylesheet" href="{{& OPT.theme_github_path}}JustNews/files/swiper.min.css">
    <link rel="stylesheet" href="{{& OPT.theme_github_path}}JustNews/files/noto+serif.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/styles/atom-one-light.min.css">
    <style>
        :root {
            --primary-color: #007bff; 
        }
        .pagination-bar { text-align: center; margin-top: 20px; }
        .pagination-bar a { text-decoration: none; padding: 5px 10px; border: 1px solid #ddd; margin: 0 5px; }
        .pagination-bar a:hover { background: #f0f0f0; }
        .pagination-bar .current { font-weight: bold; padding: 5px 10px; }
		.post-navigation { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; }
		.post-navigation .nav-previous, .post-navigation .nav-next { width: 100%; max-width: 48%; margin-bottom: 20px; }
		.post-navigation a { text-decoration: none; color: #333; }
		.post-navigation a:hover { color: var(--primary-color); }
		.post-navigation .nav-title { font-size: 14px; color: #777; margin-bottom: 5px; }
		.post-navigation .post-title { font-size: 16px; font-weight: bold; line-height: 1.4; display: block; }
		.post-navigation .nav-next { text-align: right; }
		.post-navigation .nav-image { margin-top: 10px; }
		.post-navigation .nav-image img { max-width: 100px; height: 60px; object-fit: cover; border-radius: 5px; }
		.post-navigation .nav-previous .nav-image { float: left; margin-right: 10px; }
		.post-navigation .nav-next .nav-image { float: right; margin-left: 10px; }
		.nav-links .nav-previous a, .nav-links .nav-next a { display: flex; align-items: center; }
		.nav-links .nav-previous .post-details { text-align: left; }
		.nav-links .nav-next .post-details { text-align: right; }
		.nav-links .nav-next a { flex-direction: row-reverse; }

		@media (max-width: 767px) {
			.post-navigation .nav-previous, .post-navigation .nav-next { max-width: 100%; }
			.post-navigation .nav-image img { max-width: 80px; height: 50px; }
		}
		
		#comments-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
		.comment-form-grid { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 15px; margin-bottom: 15px; }
		#comment-form textarea { width: 100%; min-height: 120px; }
		#comment-form input, #comment-form select, #comment-form textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
		#comment-form .comment-form-actions { display: flex; justify-content: flex-end; }
		#comment-form button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
		#comment-form button:hover { background-color: #0056b3; }
		#comments-list { margin-top: 30px; }
		.comment { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; display: flex; }
		.comment-avatar { margin-right: 15px; }
		.comment-avatar img { width: 48px; height: 48px; border-radius: 50%; }
		.comment-content { flex: 1; }
		.comment-meta { font-size: 13px; color: #777; margin-bottom: 5px; }
		.comment-author { font-weight: bold; color: #333; margin-right: 8px; }
		.comment-date { margin-right: 8px; }
		.comment-contact { font-size: 12px; background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
		.comment-contact .fas { margin-right: 3px; }
		.comment-body { margin-top: 5px; line-height: 1.6; color: #444; }
		#comment-form .full-width { grid-column: 1 / -1; }
		@media (max-width: 600px) { .comment-form-grid { grid-template-columns: 1fr; } }
		.comment-form-contact { display: flex; }
		.comment-form-contact select { flex: 0 0 100px; border-top-right-radius: 0; border-bottom-right-radius: 0; }
		.comment-form-contact input { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 0; }
		
    </style>
    {{{ &OPT.codeBeforHead }}}
</head>
<body>
    {{{ &OPT.codeBeforBody }}}
    <header class="header">
        <div class="container">
            <div class="logo-container">
                {{#OPT.logo}}
                <a href="/" class="logo">
                    <img src="{{& OPT.logo}}" alt="{{& OPT.siteName}} Logo">
                </a>
                {{/OPT.logo}}
                {{#OPT.showSiteNameInHeader}}
                <a href="/" class="site-name-link">
                    <span class="site-name">{{& OPT.siteName}}</span>
                </a>
                {{/OPT.showSiteNameInHeader}}
            </div>
            <nav class="main-nav">
                <ul class="nav-list">
                    {{#OPT.widgetMenuList}}
                    <li class="nav-item {{#hasChildren}}has-submenu{{/hasChildren}}">
                        <a href="{{url}}" {{^url}}onclick="return false;"{{/url}}>
                            {{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}
                            {{#hasChildren}}<i class="fas fa-chevron-down submenu-toggle"></i>{{/hasChildren}}
                        </a>
                        {{#hasChildren}}
                        <ul class="submenu">
                            {{#children}}
                            <li class="nav-item {{#hasChildren}}has-submenu{{/hasChildren}}">
                                <a href="{{url}}" {{^url}}onclick="return false;"{{/url}}>
                                    {{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}
                                    {{#hasChildren}}<i class="fas fa-chevron-right submenu-toggle-nested"></i>{{/hasChildren}}
                                </a>
                                {{#hasChildren}}
                                <ul class="submenu-nested">
                                    {{#children}}
                                    <li class="nav-item">
                                        <a href="{{url}}">{{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}</a>
                                    </li>
                                    {{/children}}
                                </ul>
                                {{/hasChildren}}
                            </li>
                            {{/children}}
                        </ul>
                        {{/hasChildren}}
                    </li>
                    {{/OPT.widgetMenuList}}
                </ul>
            </nav>
            <div class="mobile-nav-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>
    <div class="mobile-menu-container">
        <div class="mobile-menu-header">
            <div class="logo-container">
                {{#OPT.logo}}
                <a href="/" class="logo">
                    <img src="{{& OPT.logo}}" alt="{{& OPT.siteName}} Logo">
                </a>
                {{/OPT.logo}}
                {{#OPT.showSiteNameInHeader}}
                <span class="site-name">{{& OPT.siteName}}</span>
                {{/OPT.showSiteNameInHeader}}
            </div>
            <div class="mobile-menu-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <nav class="mobile-nav">
            <ul class="mobile-nav-list">
                {{#OPT.widgetMenuList}}
                <li class="mobile-nav-item {{#hasChildren}}has-submenu{{/hasChildren}}">
                    <a href="{{url}}" {{^url}}class="no-link"{{/url}}>
                        {{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}
                        {{#hasChildren}}<span class="submenu-arrow"><i class="fas fa-chevron-down"></i></span>{{/hasChildren}}
                    </a>
                    {{#hasChildren}}
                    <ul class="mobile-submenu">
                        {{#children}}
                        <li class="mobile-nav-item {{#hasChildren}}has-submenu{{/hasChildren}}">
                            <a href="{{url}}" {{^url}}class="no-link"{{/url}}>
                                {{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}
                                {{#hasChildren}}<span class="submenu-arrow"><i class="fas fa-chevron-right"></i></span>{{/hasChildren}}
                            </a>
                            {{#hasChildren}}
                            <ul class="mobile-submenu-nested">
                                {{#children}}
                                <li class="mobile-nav-item">
                                    <a href="{{url}}">{{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}</a>
                                </li>
                                {{/children}}
                            </ul>
                            {{/hasChildren}}
                            </li>
                        {{/children}}
                    </ul>
                    {{/hasChildren}}
                </li>
                {{/OPT.widgetMenuList}}
            </ul>
        </nav>
    </div>

    <main class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <article class="post-full">
                    <header class="post-header">
                        <div class="breadcrumb">
                            {{{articleBreadcrumb}}} / <span>正文</span>
                        </div>
                        <h1 class="post-title">{{articleSingle.title}}</h1>
                        <div class="post-meta">
                            <span class="meta-item"><i class="fas fa-calendar-alt"></i> {{articleSingle.createDate10}}</span>
                            {{#articleSingle.categories}}
                            <span class="meta-item category-meta">
                                <a href="/category/{{name}}/">
                                    {{#icon}}<i class="{{icon}}"></i> {{/icon}}{{name}}
                                </a>
                            </span>
                            {{/articleSingle.categories}}
                        </div>
                    </header>

                    {{#articleSingle.img}}
                    <figure class="post-feature-image">
                        <img src="{{articleSingle.img}}" alt="{{articleSingle.title}}">
                    </figure>
                    {{/articleSingle.img}}

                    <div class="post-content">
                        {{{articleSingle.content}}}
                    </div>

                    {{#articleSingle.tags}}
                    <div class="post-tags">
                        <i class="fas fa-tags"></i>
                        {{#articleSingle.tags}}
                        <a href="/tags/{{.}}/">{{.}}</a>
                        {{/articleSingle.tags}}
                    </div>
                    {{/articleSingle.tags}}
                </article>

				<nav class="post-navigation" aria-label="文章">
					<div class="nav-links">
						{{#articleNewer}}
						<div class="nav-previous">
							<a href="{{url}}" rel="prev">
								{{#img}}
								<div class="nav-image"><img src="{{img}}" alt="{{title}}"></div>
								{{/img}}
								<div class="post-details">
									<span class="nav-title"><i class="fas fa-chevron-left"></i> 上一篇</span>
									<span class="post-title">{{title}}</span>
								</div>
							</a>
						</div>
						{{/articleNewer}}

						{{#articleOlder}}
						<div class="nav-next">
							<a href="{{url}}" rel="next">
								{{#img}}
								<div class="nav-image"><img src="{{img}}" alt="{{title}}"></div>
								{{/img}}
								<div class="post-details">
									<span class="nav-title">下一篇 <i class="fas fa-chevron-right"></i></span>
									<span class="post-title">{{title}}</span>
								</div>
							</a>
						</div>
						{{/articleOlder}}
					</div>
				</nav>
				
				
                <section id="comments-section">
                    <h3>发表评论</h3>
                    <form id="comment-form">
                        <div class="comment-form-grid">
                            <input type="text" id="comment-author" placeholder="昵称 (必填)" required>
                            
                            <div class="comment-form-contact">
                                <select id="comment-contact-type">
                                    <option value="email">Email</option>
                                    <option value="qq">QQ</option>
                                    <option value="wechat">微信</option>
                                    <option value="other">其它</option>
                                </select>
                                <input type="text" id="comment-contact-value" placeholder="联系方式 (可选, 不公开)">
                            </div>
                        </div>
                        <div class="full-width">
                            <textarea id="comment-content" placeholder="请在此输入评论内容... (必填)" required></textarea>
                        </div>
                        <div class="comment-form-actions">
                            <button type="submit" id="submit-comment">提交评论</button>
                        </div>
                    </form>

                    <div id="comments-list">
                        <h3 id="comments-title" style="margin-top: 30px; display: none;">评论</h3>
                    </div>
                </section>


            </div>

            <aside class="sidebar">
                <div class="widget">
                    <h4 class="widget-title">分类</h4>
                    <ul class="widget-list widget-category">
                        {{#widgetCategoryList}}
                        <li><a href="/category/{{name}}/"><i class="{{icon}}"></i> {{name}}</a></li>
                        {{/widgetCategoryList}}
                    </ul>
                </div>
                <div class="widget">
                    <h4 class="widget-title">近期文章</h4>
                    <ul class="widget-list widget-recent-posts">
                        {{#widgetRecentlyList}}
                        <li>
                            <a href="{{url}}">{{title}}</a>
                            <span class="post-date">{{createDate10}}</span>
                        </li>
                        {{/widgetRecentlyList}}
                    </ul>
                </div>
                <div class="widget">
                    <h4 class="widget-title">标签云</h4>
                    <div class="widget-tag-cloud">
                        {{#widgetTagList}}
                        <a href="{{url}}">{{name}}</a>
                        {{/widgetTagList}}
                    </div>
                </div>
                <div class="widget">
                    <h4 class="widget-title">友情链接</h4>
                    <ul class="widget-list widget-links">
                        {{#widgetLinkList}}
                        {{#img}}
                        <li class="image-link"><a href="{{url}}" target="_blank"><img src="{{img}}" alt="{{name}}"></a></li>
                        {{/img}}
                        {{^img}}
                        <li><a href="{{url}}" target="_blank">{{name}}</a></li>
                        {{/img}}
                        {{/widgetLinkList}}
                    </ul>
                </div>
            </aside>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                {{{footer_links}}}
            </div>
            <div class="copyright">
                {{{site_footer_copyright}}}
            </div>
        </div>
    </footer>

    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
            
            // --- 评论JS ---
            const commentForm = document.getElementById('comment-form');
            const commentsList = document.getElementById('comments-list');
            const commentsTitle = document.getElementById('comments-title');
            const articleSlug = '{{articleSingle.link}}'; 
            const submitButton = document.getElementById('submit-comment');

            function loadComments() {
                // 调用新的安全 GET 接口
                fetch(`/api/comments/${articleSlug}`)
                .then(response => response.json())
                .then(comments => {
                    commentsList.innerHTML = ''; 
                    if (comments.length > 0) {
                        commentsTitle.style.display = 'block';
                        commentsTitle.textContent = `${comments.length} 条评论`;
                    } else {
                        commentsTitle.style.display = 'none';
                    }

                    comments.forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'comment';

                        // 使用服务器为Cravatar生成的临时ID
                        const avatar = `https://cravatar.cn/avatar/${comment.id}?s=48&d=mp`;
                        
                        // --- START: 已还原的联系方式逻辑（安全） ---
                        let contactHtml = '';
                        if (comment.contact && comment.contact.value) {
                            let contactIcon = 'fa-comment-dots'; // default
                            if (comment.contact.type === 'email') contactIcon = 'fa-envelope';
                            if (comment.contact.type === 'qq') contactIcon = 'fa-qq';
                            if (comment.contact.type === 'wechat') contactIcon = 'fa-weixin';

                            // --- 无需前端脱敏 ---
                            // 直接显示服务器传来的、已经脱敏的 displayValue
                            const displayValue = comment.contact.value;
                            
                            contactHtml = `
                                <span class="comment-contact">
                                    <i class="fas ${contactIcon}"></i> ${displayValue}
                                </span>
                            `;
                        }
                        // --- END: 已还原的联系方式逻辑（安全） ---

                        // --- Sanitize content ---
                        const contentDiv = document.createElement('div');
                        contentDiv.textContent = comment.content;
                        const safeContent = contentDiv.innerHTML.replace(/\n/g, '<br>');

                        commentEl.innerHTML = `
                            <div class="comment-avatar">
                                <img src="${avatar}" alt="Avatar">
                            </div>
                            <div class="comment-content">
                                <div class="comment-meta">
                                    <span class="comment-author">${document.createTextNode(comment.author).textContent}</span>
                                    <span class="comment-date">${new Date(comment.timestamp).toLocaleString()}</span>
                                    ${contactHtml}
                                </div>
                                <div class="comment-body">
                                    ${safeContent}
                                </div>
                            </div>
                        `;
                        commentsList.appendChild(commentEl);
                    });
                })
                .catch(e => console.error('Error loading comments:', e));
            }

            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = '提交中...';

                const author = document.getElementById('comment-author').value;
                const content = document.getElementById('comment-content').value;
                const contactType = document.getElementById('comment-contact-type').value;
                const contactValue = document.getElementById('comment-contact-value').value;

                if (!author || !content) {
                    alert('昵称和评论内容不能为空！');
                    submitButton.disabled = false;
                    submitButton.textContent = '提交评论';
                    return;
                }

                const newComment = {
                    author: author,
                    content: content,
                    contact: {
                        type: contactType,
                        value: contactValue
                    },
                    timestamp: Date.now()
                };

                fetch(`/api/comments/${articleSlug}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newComment)
                })
                .then(response => response.json())
                .then(savedComment => {
                    commentForm.reset();
                    loadComments(); 
                    submitButton.disabled = false;
                    submitButton.textContent = '提交评论';
                })
                .catch(e => {
                    alert('评论提交失败，请重试。');
                    console.error('Error submitting comment:', e);
                    submitButton.disabled = false;
                    submitButton.textContent = '提交评论';
                });
            });

            loadComments();
            
            // --- 移动菜单JS ---
            const mobileToggle = document.querySelector('.mobile-nav-toggle');
            const mobileMenu = document.querySelector('.mobile-menu-container');
            const mobileClose = document.querySelector('.mobile-menu-close');

            if (mobileToggle && mobileMenu && mobileClose) {
                mobileToggle.addEventListener('click', () => {
                    mobileMenu.classList.add('is-open');
                });

                mobileClose.addEventListener('click', () => {
                    mobileMenu.classList.remove('is-open');
                });

                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !mobileToggle.contains(e.target) && mobileMenu.classList.contains('is-open')) {
                        mobileMenu.classList.remove('is-open');
                    }
                });
            }

            const mobileSubmenuArrows = document.querySelectorAll('.mobile-nav-item.has-submenu .submenu-arrow');
            mobileSubmenuArrows.forEach(arrow => {
                arrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const parentItem = arrow.closest('.mobile-nav-item');
                    parentItem.classList.toggle('submenu-open');
                    const submenu = parentItem.querySelector('.mobile-submenu, .mobile-submenu-nested');
                    if (submenu) {
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });

            // --- 桌面菜单JS ---
            const desktopSubmenuToggles = document.querySelectorAll('.main-nav .nav-item.has-submenu > a');
            desktopSubmenuToggles.forEach(toggle => {
                const hasSubmenu = toggle.parentElement.classList.contains('has-submenu');
                if (hasSubmenu && !toggle.getAttribute('href')) {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        const parentItem = toggle.parentElement;
                        parentItem.classList.toggle('submenu-open');
                    });
                }
            });

            // 点击非菜单区域关闭打开的子菜单
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.main-nav .nav-item.has-submenu.submenu-open').forEach(item => {
                    if (!item.contains(e.target)) {
                        item.classList.remove('submenu-open');
                    }
                });
            });

        });
    </script>
    {{{ &OPT.commentCode }}}
</body>
</html>
