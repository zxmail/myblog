<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width,viewport-fit=cover">
    <title>{{ &title }}</title>
    <meta name="keywords" content="{{ &OPT.siteKeywords }}" />
    <meta name="description" content="{{ &OPT.siteDescription }}" />

    <link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/files/swiper.min.css"/>
    <link rel='stylesheet' href='{{ &OPT.theme_github_path }}JustNews/files/fonts/fontawesome5pro-all.min.css'>
    <link rel='stylesheet' href='{{ &OPT.theme_github_path }}JustNews/files/style.css'>
    <link rel='stylesheet' href='{{ &OPT.theme_github_path }}JustNews/files/noto+serif.css' type='text/css' media='all' />
	<link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml">
	<link rel="shortcut icon" href="{{& OPT.theme_github_path}}JustNews/files/logo2.png" type="image/x-icon">
	{{& OPT.codeBeforHead}}
</head>
<body class="m-flex">
	<header class="site-header">
    <div class="header-container">
        <div class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="fal fa-bars"></i>
        </div>
        <div class="header-left">
            <div class="logo-area">
                {{ #OPT.logo }}
                <a href="/"><img src="{{ &OPT.logo }}" alt="博客Logo" class="logo-image"></a>
                {{ /OPT.logo }}
                {{ #OPT.showSiteNameInHeader }}
                <a href="/" class="blog-name">{{ &OPT.siteName }}</a>
                {{ /OPT.showSiteNameInHeader }}
            </div>
            <nav class="main-nav" id="main-nav">
                <div class="close-menu-btn" id="close-menu-btn">&times;</div>

                <div class="mobile-nav-header">
                    <img src="{{ &OPT.theme_github_path }}JustNews/files/mobile-header.svg" alt="导航背景" class="mobile-nav-header-image">
                </div>
                <ul>
                    {{ #OPT.widgetMenuList }}
                    <li>
                        <a href="{{ &url }}">
                            {{ #icon }}<i class="{{ &icon }}" style="margin-right: 5px;"></i> {{ /icon}}{{ &name }}
                            {{! 使用我们新的、清晰无误的 hasChildren 标记来判断 }}
                            {{ #hasChildren }}
                            <span class="arrow-container"><i class="fal fa-angle-down"></i></span>
                            {{ /hasChildren }}
                        </a>
                        {{ #hasChildren }}
                        <span class="submenu-toggle"><i class="fal fa-angle-right"></i></span>
                        {{ /hasChildren }}

                        {{ #hasChildren }}
                        <ul class="sub-menu">
                            {{ #children }}
                            <li>
                                <a href="{{ &url }}">
                                    {{ #icon }}<i class="{{ &icon }}" style="margin-right: 5px;"></i> {{ /icon}}{{ &name }}
                                    {{ #hasChildren }}
                                    <span class="arrow-container"><i class="fal fa-angle-right"></i></span>
                                    {{ /hasChildren }}
                                </a>
                                {{ #hasChildren }}
                                <span class="submenu-toggle"><i class="fal fa-angle-right"></i></span>
                                {{ /hasChildren }}

                                {{ #hasChildren }}
                                <ul class="sub-menu">
                                    {{ #children }}
                                    <li>
                                        <a href="{{ &url }}">
                                            {{ #icon }}<i class="{{ &icon }}" style="margin-right: 5px;"></i> {{ /icon}}{{ &name }}
                                        </a>
                                    </li>
                                    {{ /children }}
                                </ul>
                                {{ /hasChildren }}
                            </li>
                            {{ /children }}
                        </ul>
                        {{ /hasChildren }}
                    </li>
                    {{ /OPT.widgetMenuList }}
                     <li class="login-btn-mobile">
                         <a href="/admin">
                             <button class="login-btn-header">登录</button>
                         </a>
                     </li>
                </ul>
            </nav>
            </div>

        <div class="header-right">
            <div class="search-icon" id="search-toggle">
                <i class="fal fa-search"></i>
            </div>
             <a href="/admin" class="login-link">
                 <i class="fal fa-user-circle"></i>
             </a>
        </div>
    </div>

	<div class="search-box-container" id="search-box">
        <input type="text" placeholder="输入关键词搜索..." class="search-input">
        <button class="search-button">搜索</button>
        <i class="far fa-chevron-double-up" id="close-search-btn" title="收起"></i>
    </div>
</header>
    <div id="wrap" class="container">
        <div class="main-layout">
            <div class="left-column">
                
                {{#carousel_slides.length}}
                <div class="swiper carousel-container">
                    <div class="swiper-wrapper">
                        {{#carousel_slides}}
                        <div class="swiper-slide">
                            <a href="{{ &linkUrl }}" target="_blank">
                                <img src="{{ &imageUrl }}" alt="Carousel Image">
                            </a>
                        </div>
                        {{/carousel_slides}}
                    </div>
                    <div class="swiper-pagination"></div>

                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>
                {{/carousel_slides.length}}

                <div class="article-list">
					<h3 class="widget-title">{{listTitle}}</h3>
                    <ul>
                    {{#articleList}}
                        <li class="article-item-box">
                            {{#firstImageUrl}}
                            <div class="article-item-image">
                                {{#firstCategory}}
                                <div class="image-category">
                                    <a href="/category/{{.}}/">{{.}}</a>
                                </div>
                                {{/firstCategory}}
                                <a href="{{url}}">
                                    <img src="{{firstImageUrl}}" alt="{{title}}">
                                </a>
                            </div>
                            {{/firstImageUrl}}
                            <div class="article-item-content">
								<h3>
								{{#isPinned}}<i class="fas fa-thumbtack" style="color: #f00; margin-right: 5px;" title="置顶"></i>{{/isPinned}}
								{{#isPasswordProtected}}<i class="fas fa-lock" style="color: #888; margin-right: 5px;" title="密码保护"></i>{{/isPasswordProtected}}
								<a href="{{url}}">{{title}}</a>
								</h3>
                                <p>{{contentText}}</p>
                                <div class="article-meta">
                                    <span><i class="fal fa-calendar-alt"></i> {{createDate10}}</span>
                                    {{#category[]}}
                                    <span class="meta-category hidden-mobile"><i class="fal fa-folder"></i> <a href="/category/{{.}}/">{{.}}</a></span>
                                    {{/category[]}}
                                    <span class="views"><i class="fal fa-eye"></i> {{views}}</span>
                                </div>
                            </div>
                        </li>
                    {{/articleList}}
                    </ul>
                </div>

                <nav class="pagination">
                    {{#pageNewer}}
                    <a href="{{url}}" class="prev">← 上一页</a>
                    {{/pageNewer}}
                    {{#pageOlder}}
                    <a href="{{url}}" class="next">下一页 →</a>
                    {{/pageOlder}}
                </nav>
            </div>

            <div class="right-column">
				<aside id="desktop-sidebar-wrapper">
						<div class="sidebar-inner-wrapper">
								<div class="widget widget-recent-posts">
									<h3 class="widget-title">热门文章</h3>
									<ul>
										{{#widgetRecentlyList}}
										<li class="recent-article-item-box">
											{{#firstImageUrl}}
											<div class="recent-article-item-image">
												<a href="{{url}}">
													<img src="{{firstImageUrl}}" alt="{{title}}">
												</a>
											</div>
											{{/firstImageUrl}}
											<div class="recent-article-item-content">
												<a href="{{url}}">
													{{#isPinned}}
													<i class="fas fa-thumbtack" 
													   style="color: #f00; font-size: 0.9em; margin-right: 4px;" 
													   title="置顶">
													</i>
													{{/isPinned}}
													{{#isPasswordProtected}}
													<i class="fas fa-lock" 
													   style="color: #888; font-size: 0.9em; margin-right: 4px;" 
													   title="密码保护">
													</i>
													{{/isPasswordProtected}}
													{{title}}
												</a>
												<span class="recent-article-item-date">{{createDate10}}</span>
											</div>
										</li>
										{{/widgetRecentlyList}}
									</ul>
								</div>
								<div class="widget widget-categories">
									<h3 class="widget-title">分类目录</h3>
									<ul>
										{{#widgetCategoryList}}
										<li><a href="/category/{{name}}/"> <i class="{{icon}}"></i> {{name}}</a></li>
										{{/widgetCategoryList}}
									</ul>
								</div>
								<div class="widget widget-tags">
									<h3 class="widget-title">标签</h3>
									<div class="tag-cloud">
										{{ #widgetTagList }}
											<a href="{{url}}">{{name}}</a>
										{{ /widgetTagList }}
										{{ ^widgetTagList }}
											<span>暂无标签</span>
										{{ /widgetTagList }}
									</div>
								</div>
								<div class="widget widget-comments">
										<h3 class="widget-title">最近评论</h3>
										<ul id="widget-recent-comments-list">
											<li>正在加载...</li>
										</ul>
									</div>
						</div>				
			</aside>
			</div>
		</div>

        <div class="friend-links">
             <h3 class="widget-title">友情链接</h3>
             <div class="links-container">
                 {{#widgetLinkList}}
                 <div class="link-item">
                     {{#img}}
                         <a href="{{url}}" target="_blank" title="{{name}}">
                             <img src="{{img}}" alt="{{name}}">
                         </a>
                     {{/img}}
                     {{^img}}
                         <a href="{{url}}" target="_blank">{{name}}</a>
                     {{/img}}
                 </div>
                 {{/widgetLinkList}}
             </div>
        </div>
    </div>

	<footer class="footer">
		<div class="container">
			<div class="footer-meta">
				<div class="footer-links">
					{{{ footer_links }}}
				</div>
				<p>{{{ site_footer_copyright }}}</p>
			</div>
			</div>
	</footer>

    <div class="action action-style-0 action-color-0 action-pos-0">
        <div class="action-item gotop j-top">
            <i class="fal fa-arrow-up action-item-icon"></i>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
	<script src="{{ &OPT.theme_github_path }}JustNews/files/swiper.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/files/sticky-sidebar.min.js"></script>
	<script>
		window.addEventListener('load', function() {
			if (window.innerWidth >= 992) {
				window.stickySidebarInstance = new StickySidebar('#desktop-sidebar-wrapper', { 
			   	//var sidebar = new StickySidebar('#desktop-sidebar-wrapper', {
		            topSpacing: 80, 
		            bottomSpacing: 20, 
		            containerSelector: '.main-layout', 
		            innerWrapperSelector: '.sidebar-inner-wrapper' 
		        });
			}
		});
	</script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const topButton = document.querySelector('.j-top');
            if(topButton) {
                topButton.addEventListener('click', function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchToggle = document.getElementById('search-toggle');
        const searchBox = document.getElementById('search-box');
        const closeSearchBtn = document.getElementById('close-search-btn');

        if (searchToggle && searchBox) {
            searchToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                searchBox.classList.toggle('visible');
            });
            
            searchBox.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }

        if (closeSearchBtn) {
            closeSearchBtn.addEventListener('click', function() {
                searchBox.classList.remove('visible');
            });
        }
        
        document.addEventListener('click', function() {
            if (searchBox && searchBox.classList.contains('visible')) {
                searchBox.classList.remove('visible');
            }
        });

        const menuToggle = document.getElementById('mobile-menu-toggle');
        const mainNav = document.getElementById('main-nav');
        const body = document.querySelector('body');
        const overlay = document.getElementById('overlay');
        const closeMenuBtn = document.getElementById('close-menu-btn');

        const openMenu = function() { body.classList.add('nav-open'); };
        const closeMenu = function() { body.classList.remove('nav-open'); };
        
        if (menuToggle) { menuToggle.addEventListener('click', function(event) { event.stopPropagation(); openMenu(); }); }
        if (overlay) { overlay.addEventListener('click', closeMenu); }
        if (closeMenuBtn) { closeMenuBtn.addEventListener('click', closeMenu); }
        mainNav.addEventListener('click', function(event){ event.stopPropagation(); });

        const submenuToggles = document.querySelectorAll('.main-nav .submenu-toggle');
        submenuToggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                this.classList.toggle('active');
                const subMenu = this.nextElementSibling;
                if (subMenu && subMenu.classList.contains('sub-menu')) {
                    subMenu.classList.toggle('open');
                }
            });
        });
		
		function renderSidebarComments(comments) {
            const sidebarList = document.getElementById('widget-recent-comments-list');
            if (!sidebarList) return; 

            sidebarList.innerHTML = '';

            if (!comments || comments.length === 0) {
                sidebarList.innerHTML = '<li>暂无评论</li>';
                return;
            }

            const recentComments = comments.slice(0, 5);

recentComments.forEach(comment => {
                const li = document.createElement('li');
                li.style.borderBottom = '1px solid #eee'; 
                li.style.padding = '10px 0';

                // --- START: 新增跳转链接 ---
                // 1. 创建 <a> 标签
                const link = document.createElement('a');
                
                // 2. 构造 URL。
                // comment.articleSlug 是文章ID
                // comment.id 是评论的唯一ID
                // article.html 中的评论列表项 <li> ID 格式为 "comment-..."
                // 最终 URL: /article/ARTICLE_ID/#comment-COMMENT_ID
                link.href = `/article/${comment.articleSlug}/#comment-${comment.id}`;

                // 3. 添加样式，使其看起来像普通文本
                link.style.textDecoration = 'none';
                link.style.color = 'inherit'; // 继承父元素的颜色
                link.style.display = 'block'; // 使其成为块级元素以便点击
                // --- END: 新增跳转链接 ---

                // --- 评论内容 ---
                const contentP = document.createElement('p');
                contentP.style.marginBottom = '5px';
                contentP.textContent = comment.content;
                
                // --- 评论元信息 (联系方式) ---
                const metaSpan = document.createElement('span');
                metaSpan.style.fontSize = '12px';
                metaSpan.style.color = '#888';

                if (comment.contact && comment.contact.value) {
                    let typeLabel = '联系';
                    switch(comment.contact.type) {
                        case 'email': typeLabel = '邮箱'; break;
                        case 'qq': typeLabel = 'QQ'; break;
                        case 'wechat': typeLabel = '微信'; break;
                        case 'telegram': typeLabel = 'Telegram'; break;
                    }
                    metaSpan.textContent = `[${typeLabel}: ${comment.contact.value}]`;
                } else {
                    metaSpan.textContent = '[匿名]';
                }

                // --- 修改 Appending 逻辑 ---
                // 将内容和元信息添加到 <a> 标签中
                link.appendChild(contentP);
                link.appendChild(metaSpan);
                
                // 将 <a> 标签添加到 <li> 中
                li.appendChild(link);
                
                // 将 <li> 添加到列表中
                sidebarList.appendChild(li);
            });
            
            if(sidebarList.lastChild) {
                sidebarList.lastChild.style.borderBottom = 'none';
            }
        }

        // 2. 专门用于获取侧边栏评论的函数
        async function fetchSidebarComments() {
            try {
                // 调用在 index_plus.js 中定义的、返回脱敏数据的API
                const response = await fetch('/api/comments_all');
                if (!response.ok) throw new Error('获取评论失败');
                
                const allComments = await response.json();
                
                // 用所有评论去渲染侧边栏
                renderSidebarComments(allComments);

            } catch (error) {
                console.error('获取侧边栏评论时出错:', error);
                const sidebarList = document.getElementById('widget-recent-comments-list');
                if (sidebarList) {
                    sidebarList.innerHTML = '<li>加载失败</li>';
                }
            }
        }

        // 3. 页面加载时执行
        fetchSidebarComments();
		// --- START: 在这里添加搜索按钮的 JS 逻辑 ---
        const searchButton = document.querySelector('.search-button');
        const searchInput = document.querySelector('.search-input');

        if(searchButton && searchInput) {
            const performSearch = () => {
                const query = searchInput.value.trim();
                if (query) {
                    // 重定向到搜索结果页 (这个 URL 稍后需要在 index_plus.js 中实现)
                    window.location.href = '/search/' + encodeURIComponent(query) + '/';
                }
            };

            // 点击按钮时搜索
            searchButton.addEventListener('click', performSearch);

            // 在输入框按回车键时搜索
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
        // --- END: 搜索按钮的 JS 逻辑 ---
        
        // --- END: 新增的最近评论 JS 逻辑 ---

        const swiper = new Swiper('.swiper', {
            autoHeight: true,
            loop: true,
            autoplay: {
                delay: 3000,
                disableOnInteraction: false,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
        });
    });
</script>
</body>
</html>
