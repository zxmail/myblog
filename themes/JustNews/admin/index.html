<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-g">
	<title>CF-blog后台</title>
	<link rel="icon" type="image/x-icon" href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon" href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico"/>
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.css">
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.css">
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/files/fonts/fontawesome5pro-all.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/files/tinymce/skins/ui/oxide/skin.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/admin/files/style.css">
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/jquery.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/defaults-zh_CN.min.js"></script>
</head>
<body>

<div id="login-wrapper" style="display: none;">
    <div class="login-container">
        <div class="login-header">
            {{ #OPT.logo }}
                <img src="{{ &OPT.logo }}" alt="Logo">
            {{ /OPT.logo }}
            {{ ^OPT.logo }}
                {{ #OPT.siteName }}
                    <h1>{{ &OPT.siteName }}</h1>
                {{ /OPT.siteName }}
                {{ ^OPT.siteName }}
                    <h1>后台登录</h1>
                {{ /OPT.siteName }}
            {{ /OPT.logo }}
        </div>
        <form class="login-form" id="login-form">
            <div class="form-group">
                <input type="password" id="admin-password" class="form-control" placeholder="请输入密码" required>
            </div>
            <button type="submit" class="btn btn-primary btn-login">登录</button>
        </form>
        <div class="footer-link">
            <a href="/">&larr; 返回到博客首页</a>
        </div>
    </div>
</div>


<div id="admin-container" class="admin-container">
	<div class="admin-sidebar">
		<div class="sidebar-header">
			<a href="/" >CF-blog</a>
		</div>
		<ul class="nav nav-pills nav-stacked">
			<li class="active"><a data-toggle="tab" href="#list"><i class="fas fa-fw fa-list-alt"></i> 我的文章</a></li>
			<li><a data-toggle="tab" href="#new"><i class="fas fa-fw fa-plus"></i> 新建/编辑</a></li>
			<li><a data-toggle="tab" href="#category-menu"><i class="fas fa-fw fa-sitemap"></i> 分类/菜单</a></li>
			<li><a data-toggle="tab" href="#site-config"><i class="fas fa-fw fa-cog"></i> 网站设置</a></li>
			<li><a data-toggle="tab" href="#comments-manager"><i class="fas fa-fw fa-comments"></i> 评论管理</a></li>
			<li><a data-toggle="tab" href="#carousel-manager"><i class="fas fa-fw fa-images"></i> 轮播管理</a></li>
			<li><a data-toggle="tab" href="#pub"><i class="fas fa-fw fa-paper-plane"></i> 发布全站</a></li>
			<li><a href="#" id="logout-button"><i class="fas fa-fw fa-sign-out-alt"></i> 退出登录</a></li>
		</ul>
	</div>

	<div class="admin-content">
		<div class="tab-content">
			<div class="tab-pane fade in active" id="list">
				<div class="container-fluid">
					<h3>我的文章</h3>
					<table class="table table-striped" id="articleList">
						<thead>
							<tr>
								<th>ID</th>
								<th>标题</th>
								<th>创建日期</th>
                                <th>分类</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
					<input type="hidden" name="page" id="page" value='1'>
					<a id="loadmore" class="btn btn-default">加载更多...</a>
				</div>
			</div>

			<div class="tab-pane fade" id="new">
				<div class="container-fluid">
					<h3 id="labelNew">新增文章 <span style="color: red;">*</span></h3>
					<form id="addNewForm" class="form-inline" >
						<div class="form-group" style="width: 98%">
							<input type="hidden" class="form-control" name="id" id="id" >
							<input type="text" class="form-control" name="title" id="title" placeholder="标题" style="width: 100%;" required="true">
						</div>
						<div class="form-group">
							<label>特色图片</label>
							<input type="url" class="form-control" style="width: 400px;"  name="img" id="img" placeholder="图片URL" >
						</div>
						<div class="form-group">
							<label>永久链接</label>
							<input type="text" class="form-control" name="link" id="link" placeholder="英文或拼音" required="true">
						</div>
						<div class="form-group">
							<label>创建日期<span style="color: red;">*</span></label>
							<input type="datetime-local" class="form-control" id="createDate" name="createDate" placeholder=""  required="true">
						</div>
						<div class="form-group">
							<label>分类<span style="color: red;">*</span></label>
							<select class="selectpicker" multiple name="category[]" id="category">
							</select>
						</div>
						<div class="form-group">
							<label>标签</label>
							<input type="text" class="form-control" name="tags" id="tags" placeholder="标签1,标签2">
						</div>
						<div class="form-group">
							<label>权重</label>
							<input type="text" class="form-control" name="priority" id="priority" value='0.5' placeholder="0.1 - 1.0">
						</div>
						<div class="form-group">
							<label>更新频率</label>
								<select class="form-control" id="changefreq" name="changefreq">
								<option value="daily" selected  = "selected" >daily</option>
								<option value="hourly" >hourly</option>
								<option value="weekly" >weekly</option>
								<option value="monthly" >monthly</option>
								<option value="yearly" >yearly</option>
								<option value="never" >never</option>
								<option value="always" >always</option>
								</select>
						</div>
						<a  tabindex="0"  role="button"  type="submit" id="btn_saveAddNew" class="btn btn-primary" onclick="saveAddNew()">保存文章</a>
						<textarea id="content" name="content"></textarea>
					</form>
				</div>
			</div>

			<div class="tab-pane fade" id="category-menu">
				<div class="container-fluid">
					<h3>分类与菜单设置</h3>
					<div class="panel panel-default">
						<div class="panel-heading">分类设置</div>
						<div class="panel-body">
							<div class="alert alert-info" style="font-size: 13px;">
								<b>使用说明:</b><br>
								- 点击“+ 添加分类”来创建新的分类。<br>
								- <b>名称</b>：分类的显示名称（必填）。<br>
								- <b>图标</b>：可选。填写 FontAwesome 5 Pro 图标的完整class，例如 <code>fas fa-home</code> 或 <code>fab fa-github</code>。
							</div>
							<div id="category-list">
								</div>
							<button type="button" class="btn btn-success btn-sm" onclick="addCategory()">
								<i class="fas fa-plus"></i> 添加分类
							</button>
						</div>
					</div>

					<div class="panel panel-default">
						<div class="panel-heading">菜单设置 (支持多级菜单)</div>
						<div class="panel-body">
							<div class="alert alert-info" style="font-size: 13px;">
								<b>使用说明:</b><br>
								- 点击“+ 添加一级菜单”来创建新的顶级菜单项。<br>
								- <b>名称</b>：菜单的显示名称（必填）。<br>
								- <b>链接</b>：菜单的跳转地址。如果这是一个包含子菜单的父菜单，建议填写 <code>#</code>。<br>
								- <b>图标</b>：可选。填写 FontAwesome 5 Pro 图标的完整class。<br>
								- 点击菜单项右侧的 <button class="btn btn-info btn-xs" disabled><i class="fas fa-plus"></i></button> 按钮可以为其添加子菜单（最多支持三级）。<br>
								- 点击 <button class="btn btn-danger btn-xs" disabled><i class="fas fa-trash"></i></button> 按钮可以删除该菜单及其所有子菜单。
							</div>
							<div id="menu-list">
							</div>
							<button type="button" class="btn btn-success btn-sm" onclick="addMenuItem(1, '#menu-list')">
								<i class="fas fa-plus"></i> 添加一级菜单
							</button>
						</div>
					</div>
					<a tabindex="0" role="button" type="button" class="btn btn-primary" onclick="saveCategoryMenuSettings()">
						<i class="fas fa-save"></i> 保存分类与菜单
					</a>
				</div>
			</div>
			
			<div class="tab-pane fade" id="site-config">
				<div class="container-fluid">
					<h3>网站设置</h3>
					<form id="configForm" role="form">
						<div class="form-group">
							<label for="siteName">博客名称 (可选, 用于登录页)</label>
							<input type="text" class="form-control" id="siteName" name="siteName" placeholder="例如：我的博客">
						</div>
                        <div class="form-group">
                            <label for="showSiteNameInHeader">页头显示博客名称</label>
                            <select class="form-control" id="showSiteNameInHeader" name="showSiteNameInHeader">
                                <option value="true" {{#showSiteNameInHeader_true}}selected{{/showSiteNameInHeader_true}}>显示</option>
                                <option value="false" {{#showSiteNameInHeader_false}}selected{{/showSiteNameInHeader_false}}>隐藏</option>
                            </select>
                        </div>
						<div class="form-group">
							<label for="logo">Logo图片地址 (可选)</label>
							<input type="url" class="form-control" id="logo" name="logo" placeholder="https://example.com/logo.png">
						</div>
						<div class="form-group">
							<label for="site_description">网站描述</label>
							<textarea class="form-control" id="site_description" name="site_description" rows="3" placeholder="一段简短的网站描述"></textarea>
						</div>
						<div class="form-group">
							<label for="site_keywords">网站关键词</label>
							<textarea class="form-control" id="site_keywords" name="site_keywords" rows="3" placeholder="例如：技术,博客,Cloudflare"></textarea>
						</div>
						<div class="form-group">
							<label>页脚链接管理</label>
							<div id="footer-links-container">
							</div>
							<button type="button" class="btn btn-info mt-2" id="add-footer-link" style="margin-top: 5px;">
								<i class="fas fa-plus"></i> 添加链接
							</button>
						</div>
						<div class="form-group">
							<label for="site_footer_copyright">页脚版权信息</label>
							<textarea class="form-control" id="site_footer_copyright" rows="3" placeholder="例如：© 2025 Your Blog. All Rights Reserved."></textarea>
						</div>
						<hr/>
						<div class="form-group">
							<label>友情链接</label>
							<div class="panel panel-default">
								<div class="panel-heading">图片链接</div>
								<div class="panel-body" id="image-links-container">
									</div>
								<div class="panel-footer">
									<button type="button" class="btn btn-success btn-sm" onclick="addLink('image')">
										<i class="fas fa-plus"></i> 添加图片链接
									</button>
								</div>
							</div>
							<div class="panel panel-default">
								<div class="panel-heading">文字链接</div>
								<div class="panel-body" id="text-links-container">
									</div>
								<div class="panel-footer">
									<button type="button" class="btn btn-success btn-sm" onclick="addLink('text')">
										<i class="fas fa-plus"></i> 添加文字链接
									</button>
								</div>
							</div>
							<textarea id="WidgetLink" name="WidgetLink" style="display: none;"></textarea>
						</div>
						<a tabindex="0" role="button" type="button" class="btn btn-primary" onclick="saveSiteSettings()">
							<i class="fas fa-save"></i> 保存网站设置
						</a>
					</form>
					<hr/>
					<h3>导入/导出</h3>
					<form id="importForm" role="form" >
						<div class="form-group">
							<label for="name">将下方完整JSON复制/粘贴可用于备份和恢复</label>
							<textarea class="form-control" id="importJson" name="importJson" rows="5" placeholder='从导出的文件中复制完整的JSON粘贴到这里'></textarea>
						</div>
						<a tabindex="0" role="button" type="button" id="btn_import" class="btn btn-warning" onclick="importBlog()">导入</a>
						<a tabindex="0" role="button" id="btn_export" class="btn btn-info" href="/admin/export/" target="_blank">导出</a>
					</form>
				</div>
			</div>

			<div class="tab-pane fade" id="comments-manager">
				<div class="container-fluid">
					<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" style="padding-bottom: 9px !important; margin-bottom: 1rem !important; border-bottom: 1px solid #eee !important;">
						<h3 style="margin: 0;">评论管理</h3>
						<div class="btn-toolbar mb-2 mb-md-0">
							<button type="button" class="btn btn-sm btn-danger" id="batch-delete-btn">
								<i class="fas fa-trash"></i> 删除选中
							</button>
						</div>
					</div>

					<div class="table-responsive">
						<table class="table table-striped table-sm">
							<thead>
								<tr>
									<th style="width: 30px;"><input type="checkbox" id="select-all-comments"></th>
									<th>文章 Slug</th>
									<th>评论内容</th>
									<th>联系方式</th>
									<th>评论时间</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="comments-list">
								</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="carousel-manager">
				<div class="container-fluid">
					<h3>轮播海报管理</h3>
					<div class="jumbotron" style="padding: 20px; margin-top: 20px;">
						<h4>新增轮播图</h4>
						<form>
							<div class="form-group">
								<label for="imageUrl">图片URL</label>
								<input type="text" class="form-control" id="imageUrl" placeholder="请输入图片的URL">
							</div>
							<div class="form-group">
								<label for="linkUrl">链接URL</label>
								<input type="text" class="form-control" id="linkUrl" placeholder="请输入点击图片后跳转的URL">
							</div>
							<button type="button" class="btn btn-primary" onclick="addCarousel()">添加</button>
						</form>
					</div>
					<div class="table-responsive">
						<table class="table table-striped table-sm">
							<thead>
								<tr>
									<th>图片预览</th>
									<th>图片URL</th>
									<th>链接URL</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="carousel-list">
							</tbody>
						</table>
					</div>
				</div>
			</div>
			
			<div class="tab-pane fade" id="pub">
				<div class="container-fluid">
					<div class="jumbotron" >
						<h3>发布全站</h3>
						<p class="lead">
						由于前端使用缓存, 在执行【新建文章、编辑文章、修改网站设置】等操作后，必须点击“发布”按钮来清理旧的缓存，否则前台页面不会显示最新的内容。<br/>
						发布后，建议使用 <strong>Ctrl+F5</strong> (或 Command+Shift+R) 强制刷新您的博客页面以查看最新效果。
						</p>
						<a href="#" class="btn btn-lg btn-danger" onclick="publish()"> <i class="fas fa-paper-plane"></i> 立即发布 </a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/tinymce.min.js"></script>
<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/langs/zh_CN.js"></script>
<script type="text/javascript">
	$(function() {
        const loginWrapper = document.getElementById('login-wrapper');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('admin-password');
        const logoutButton = document.getElementById('logout-button');
        const adminContainer = document.getElementById('admin-container');

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            const enteredPassword = passwordInput.value;
			document.cookie = "password=" + enteredPassword + ";path=/";
			sessionStorage.setItem('isAdminLoggedIn', 'true');
			checkLoginStatus();
        });

        logoutButton.addEventListener('click', function(event) {
            event.preventDefault();
            sessionStorage.removeItem('isAdminLoggedIn');
            document.cookie = "password=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            passwordInput.value = '';
            checkLoginStatus();
        });

        function checkLoginStatus() {
             if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                loginWrapper.style.display = 'none';
                adminContainer.style.display = 'flex';
				loadInitialData();
            } else {
                loginWrapper.style.display = 'flex';
                adminContainer.style.display = 'none';
            }
        }
		
        checkLoginStatus();

		var isDataLoaded = false;
		function loadInitialData() {
			if (isDataLoaded) return;
			isDataLoaded = true;

tinymce.init({
    selector: '#content',
    language: 'zh_CN',
    height: 640,
    plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking save table directionality emoticons template paste',
    toolbar: 'insertfile undo redo | styleselect fontsizeselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons | code', // 在这里添加了 "code"
});

			$('#createDate').val(new Date().toISOString().slice(0, 16));
			
			$('#siteName').val(`{{& OPT.siteName }}`);
			$('#logo').val(`{{& OPT.logo }}`);
			$('#site_description').val(`{{& site_description }}`);
			$('#site_keywords').val(`{{& site_keywords }}`);
			$('#site_footer_copyright').val(`{{& site_footer_copyright }}`);

			const footerLinksContainer = $('#footer-links-container');
			footerLinksContainer.empty();
			try {
                var tempDiv = $('<div>');
                tempDiv.html(`{{& footer_links }}`);
                var decodedJsonString = tempDiv.text();

				if (decodedJsonString.trim()) {
                    const footerLinks = JSON.parse(decodedJsonString);
                    if (footerLinks && Array.isArray(footerLinks)) {
                        footerLinks.forEach(link => {
                            const linkHtml = `
                                <div class="input-group" style="margin-top: 5px;">
                                    <span class="input-group-addon">图标</span>
                                    <input type="text" class="form-control" placeholder="例: fas fa-link" value="${link.icon || ''}">
                                    <span class="input-group-addon">名称</span>
                                    <input type="text" class="form-control" placeholder="链接名称" value="${link.text || ''}">
                                    <span class="input-group-addon">URL</span>
                                    <input type="text" class="form-control" placeholder="https://..." value="${link.url || ''}">
                                    <div class="input-group-btn">
                                        <button class="btn btn-danger remove-footer-link" type="button"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>`;
                            footerLinksContainer.append(linkHtml);
                        });
                    }
                }
			} catch(e) { 
                console.error("解析页脚链接失败:", e, "原始数据:", `{{& footer_links }}`);
            }

			var initialCategories = JSON.parse(`{{& widgetCategoryList }}`);
			var initialMenu = JSON.parse(`{{& widgetMenuList }}`);
			var initialLink = JSON.parse(`{{& widgetLinkList }}`);

			renderCategories(initialCategories);
			renderMenu(initialMenu, $('#menu-list'));

			if (initialLink && Array.isArray(initialLink)) {
                initialLink.forEach(function(link) {
                    if (link.type === 'image' || link.img) {
                        addLink('image', link);
                    } else {
                        addLink('text', link);
                    }
                });
            }
			
			updateCategoryDropdown(initialCategories);
			$("#loadmore").click();
		}

		function updateCategoryDropdown(categories) {
			var category_select = $('#category');
			category_select.empty();
			if (categories && categories.length > 0) {
				$.each(categories, function(i, cat) {
					category_select.append('<option value="' + cat.name + '">' + cat.name + '</option>');
				});
			}
			category_select.selectpicker('refresh');
		}

        $('a[data-toggle="tab"][href="#new"]').on('click', function(e) {
            if (!$(e.target).closest('.admin-sidebar').length || !$('#new').hasClass('active')) {
                 resetForm();
            }
        });
	});

	function resetForm() {
		$('#addNewForm')[0].reset();
		$('#id').val('');
		$('#labelNew').text("新增文章 *");
		if (tinymce.get('content')) {
			tinymce.get('content').setContent('');
		}
		$('#category').selectpicker('val', []);
		$('#createDate').val(new Date().toISOString().slice(0, 16));
	}

	$("#loadmore").click(function(){
		var page=$("#page").val();
		$.ajax({
			url:"/admin/getList/" + page + "/",
			type:'GET',
			dataType:"json",
			success:function(data){
				if(data && data.length > 0) {
					var tableContent="";
					$.each(data,function(i, Info){
						tableContent += `<tr id="article-row-${Info.id}">
							<td>${Info.id}</td>
							<td>${Info.title}</td>
							<td>${Info.createDate ? Info.createDate.replace("T"," ") : ''}</td>
                            <td>${Info['category[]'] ? Info['category[]'].join(', ') : ''}</td>
							<td>
								<button class="btn btn-primary btn-xs" onclick="editArticle('${Info.id}')">编辑</button>
								<button class="btn btn-danger btn-xs" onclick="deleteArticle('${Info.id}')">删除</button>
							</td>
						</tr>`;
					})
					$("#articleList tbody").append(tableContent);
					$("#page").val(++page);
				} else {
					$("#loadmore").text("没有更多了").prop("disabled", true);
				}
			}
		});
	})

	function editArticle(id) {
		$.ajax({
			url: "/admin/get/" + id,
			type: 'GET',
			dataType: "json",
			success: function(articleJson) {
				if (articleJson) {
					resetForm();
					$('#id').val(articleJson.id);
					$('#title').val(articleJson.title);
					$('#img').val(articleJson.img);
					$('#link').val(articleJson.link);
					$('#createDate').val(articleJson.createDate.replace(" ", "T"));
					$('#tags').val(articleJson.tags);
					$('#priority').val(articleJson.priority !== undefined ? articleJson.priority : '0.5');
					$('#changefreq').val(articleJson.changefreq !== undefined ? articleJson.changefreq : 'daily');
					
					if (tinymce.get('content')) {
						tinymce.get('content').setContent(articleJson.content || '');
					}

					$('#category').selectpicker('val', articleJson['category[]'] || []);
					
					$('#labelNew').text("编辑文章: " + articleJson.id);
					$('a[data-toggle="tab"][href="#new"]').tab('show');
					
					window.scrollTo(0, 0);

				} else {
					alert("获取文章失败！");
				}
			},
			error: function() {
				alert("请求文章数据失败，请检查网络或登录状态。");
			}
		});
	}

	function deleteArticle(id) {
		if (confirm("确定要删除这篇文章吗？此操作不可恢复。")) {
			$.ajax({
				url: "/admin/delete/" + id,
				type: 'POST',
				dataType: "json",
				success: function(result) {
					if (result.msg === "OK") {
						alert("删除成功！");
						$('#article-row-' + id).remove();
					} else {
						alert("删除失败: " + result.msg);
					}
				},
				error: function() {
					alert("请求失败，请检查网络或登录状态。");
				}
			});
		}
	}

	function saveAddNew(){
		if($('#title').val() == "" || $('#createDate').val() == "" || !$('#category').val() || $('#category').val().length === 0){
			alert("标题、创建日期和分类为必填项！");
			return;
		}
		var postURL = ($('#id').val()) ? "/admin/saveEdit/" : "/admin/saveAddNew/";
		tinymce.triggerSave();
		$.ajax({
			type: "POST", dataType: "json", url: postURL,
			contentType: "application/json; charset=utf-8",
			data: JSON.stringify($("#addNewForm").serializeArray()),
			success: function (result) {
				if(result && result.msg === "OK"){
					if (result.id){ $('#id').val(result.id); $('#labelNew').text("编辑文章: "+result.id); }
					alert("保存成功！");
				} else { alert("保存失败: " + (result ? result.msg : '未知错误')); }
			},
			error: function() { alert("请求失败，请检查网络或登录状态。"); }
		});
	}

	function renderCategories(categories) {
		var list = $('#category-list');
		list.empty();
		if (categories && categories.length > 0) {
			$.each(categories, function(index, category) {
				var categoryHtml = `<div class="form-group category-item"><div class="input-group"><span class="input-group-addon">名称</span><input type="text" class="form-control" value="${category.name || ''}" placeholder="分类名称 (必填)"><span class="input-group-addon">图标</span><input type="text" class="form-control" value="${category.icon || ''}" placeholder="例: fas fa-home"><div class="input-group-btn"><button class="btn btn-danger" type="button" onclick="removeCategory(this)"><i class="fas fa-trash"></i></button></div></div></div>`;
				list.append(categoryHtml);
			});
		}
	}

	function addCategory() {
		var list = $('#category-list');
		var categoryHtml = `<div class="form-group category-item"><div class="input-group"><span class="input-group-addon">名称</span><input type="text" class="form-control" value="" placeholder="分类名称 (必填)"><span class="input-group-addon">图标</span><input type="text" class="form-control" value="" placeholder="例: fas fa-home"><div class="input-group-btn"><button class="btn btn-danger" type="button" onclick="removeCategory(this)"><i class="fas fa-trash"></i></button></div></div></div>`;
		list.append(categoryHtml);
	}

	function removeCategory(button) {
		$(button).closest('.category-item').remove();
	}
	
	function renderMenu(menus, container) {
		var containerEl = $(container);
		containerEl.empty();
		if (menus && menus.length > 0) {
			$.each(menus, function(index, menu) {
				var currentLevel = (containerEl.parents('.menu-item').length) + 1;
				var addSubMenuButton = currentLevel < 3 ? `<button class="btn btn-info btn-xs" type="button" onclick="addMenuItem(${currentLevel + 1}, this)"><i class="fas fa-plus"></i></button>` : '';
				var menuHtml = `
					<div class="form-group menu-item" data-level="${currentLevel}">
						<div class="input-group">
							<span class="input-group-addon">名称</span><input type="text" class="form-control" value="${menu.name || ''}" placeholder="菜单名称">
							<span class="input-group-addon">链接</span><input type="text" class="form-control" value="${menu.url || ''}" placeholder="URL">
							<span class="input-group-addon">图标</span><input type="text" class="form-control" value="${menu.icon || ''}" placeholder="例: fas fa-home">
							<div class="input-group-btn">
								${addSubMenuButton}
								<button class="btn btn-danger btn-xs" type="button" onclick="removeMenuItem(this)"><i class="fas fa-trash"></i></button>
							</div>
						</div>
						<div class="sub-menu-container" style="padding-left: 30px;"></div>
					</div>`;
				containerEl.append(menuHtml);

				if (menu.children && menu.children.length > 0) {
					var newContainer = containerEl.children('.menu-item').last().find('.sub-menu-container');
					renderMenu(menu.children, newContainer);
				}
			});
		}
	}

	function addMenuItem(level, element) {
		var addSubMenuButton = level < 3 ? `<button class="btn btn-info btn-xs" type="button" onclick="addMenuItem(${level + 1}, this)"><i class="fas fa-plus"></i></button>` : '';
		var menuHtml = `
			<div class="form-group menu-item" data-level="${level}">
				<div class="input-group">
					<span class="input-group-addon">名称</span><input type="text" class="form-control" value="" placeholder="菜单名称">
					<span class="input-group-addon">链接</span><input type="text" class="form-control" value="" placeholder="URL">
					<span class="input-group-addon">图标</span><input type="text" class="form-control" value="" placeholder="例: fas fa-home">
					<div class="input-group-btn">
						${addSubMenuButton}
						<button class="btn btn-danger btn-xs" type="button" onclick="removeMenuItem(this)"><i class="fas fa-trash"></i></button>
					</div>
				</div>
				<div class="sub-menu-container" style="padding-left: 30px;"></div>
			</div>`;

		var container = (level === 1) ? $(element) : $(element).closest('.menu-item').children('.sub-menu-container');
        container.append(menuHtml);
	}

	function removeMenuItem(button) {
		$(button).closest('.menu-item').remove();
	}

	function getMenuItemsFromDom(container) {
		var menus = [];
		$(container).children('.menu-item').each(function() {
			var name = $(this).find('input').eq(0).val();
			if (name) {
				var menu = {
					name: name,
					url: $(this).find('input').eq(1).val(),
					icon: $(this).find('input').eq(2).val()
				};
				var subContainer = $(this).children('.sub-menu-container');
				if (subContainer.children('.menu-item').length > 0) {
					menu.children = getMenuItemsFromDom(subContainer);
				}
				menus.push(menu);
			}
		});
		return menus;
	}

	function saveCategoryMenuSettings() {
		var categories = [];
		$('#category-list .category-item').each(function() {
			var name = $(this).find('input').eq(0).val();
			var icon = $(this).find('input').eq(1).val();
			if (name) { categories.push({ name: name, icon: icon }); }
		});

		var menus = getMenuItemsFromDom($('#menu-list'));

		var configData = [
			{ name: 'WidgetCategory', value: JSON.stringify(categories) },
			{ name: 'WidgetMenu', value: JSON.stringify(menus) },
		];

		$.ajax({
			type: "POST", dataType: "json", contentType: "application/json; charset=utf-8",
			url: "/admin/saveConfig/", data: JSON.stringify(configData),
			success: function (result) {
				alert("保存成功！");
				updateCategoryDropdown(categories);
			},
			error: function() { alert('保存失败，请检查网络或登录状态。'); }
		});
	}

	function addLink(type, data = {}) {
        const containerId = type === 'image' ? '#image-links-container' : '#text-links-container';
        const container = $(containerId);
        let linkHtml = '';

        if (type === 'image') {
            linkHtml = `
                <div class="form-group link-item" data-type="image">
                    <div class="input-group">
                        <span class="input-group-addon">图片URL</span>
                        <input type="url" class="form-control" value="${data.img || ''}" placeholder="https://example.com/image.png">
                        <span class="input-group-addon">链接URL</span>
                        <input type="url" class="form-control" value="${data.url || ''}" placeholder="https://example.com/link">
						<span class="input-group-addon">悬停文字</span>
                        <input type="text" class="form-control" value="${data.name || ''}" placeholder="可选, 鼠标悬停时显示">
                        <div class="input-group-btn">
                            <button class="btn btn-danger" type="button" onclick="removeLink(this)"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
        } else { // text
            linkHtml = `
                <div class="form-group link-item" data-type="text">
                    <div class="input-group">
                        <span class="input-group-addon">文字</span>
                        <input type="text" class="form-control" value="${data.name || ''}" placeholder="我的博客">
                        <span class="input-group-addon">链接URL</span>
                        <input type="url" class="form-control" value="${data.url || ''}" placeholder="https://example.com/link">
                        <div class="input-group-btn">
                            <button class="btn btn-danger" type="button" onclick="removeLink(this)"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
        }
        container.append(linkHtml);
    }

    function removeLink(button) {
        $(button).closest('.link-item').remove();
    }
	
	$(document).on('click', '#add-footer-link', function() {
		const linksContainer = $('#footer-links-container');
		const linkHtml = `
			<div class="input-group" style="margin-top: 5px;">
				<span class="input-group-addon">图标</span>
				<input type="text" class="form-control" placeholder="例: fas fa-link">
				<span class="input-group-addon">名称</span>
				<input type="text" class="form-control" placeholder="链接名称">
				<span class="input-group-addon">URL</span>
				<input type="text" class="form-control" placeholder="https://...">
				<div class="input-group-btn">
					<button class="btn btn-danger remove-footer-link" type="button"><i class="fas fa-trash"></i></button>
				</div>
			</div>`;
		linksContainer.append(linkHtml);
	});

	$(document).on('click', '.remove-footer-link', function() {
		$(this).closest('.input-group').remove();
	});

	function saveSiteSettings(){
		var links = [];
        $('.link-item').each(function() {
            var type = $(this).data('type');
            var inputs = $(this).find('input');
            if (type === 'image') {
                var imgUrl = inputs.eq(0).val();
                var linkUrl = inputs.eq(1).val();
				var nameText = inputs.eq(2).val();
                if (imgUrl && linkUrl) {
                    links.push({ type: 'image', img: imgUrl, url: linkUrl, name: nameText });
                }
            } else { 
                var nameText = inputs.eq(0).val();
                var linkUrl = inputs.eq(1).val();
                if (nameText && linkUrl) {
                    links.push({ type: 'text', name: nameText, url: linkUrl });
                }
            }
        });

		const footerLinks = [];
		$('#footer-links-container .input-group').each(function() {
			const icon = $(this).find('input').eq(0).val();
			const text = $(this).find('input').eq(1).val();
			const url = $(this).find('input').eq(2).val();
			if (icon || text || url) {
				footerLinks.push({ icon: icon, text: text, url: url });
			}
		});

		var configData = [
			{ name: 'siteName', value: $('#siteName').val() },
			{ name: 'logo', value: $('#logo').val() },
			{ name: 'site_description', value: $('#site_description').val() },
			{ name: 'site_keywords', value: $('#site_keywords').val() },
			{ name: 'site_footer_copyright', value: $('#site_footer_copyright').val() },
			{ name: 'footer_links', value: JSON.stringify(footerLinks) },
			{ name: 'WidgetLink', value: JSON.stringify(links) },
			{ name: 'showSiteNameInHeader', value: $('#showSiteNameInHeader').val() }
		];

		$.ajax({
			type: "POST", dataType: "json", contentType: "application/json; charset=utf-8",
			url: "/admin/saveConfig/", data: JSON.stringify(configData),
			success: function (result) {
				alert("保存成功！");
			},
			error: function() { alert('保存失败，请检查网络或登录状态。'); }
		});
	}

	function importBlog(){
		if(!isJSON($('#importJson').val())) { alert("导入的JSON格式错误！"); return; }
		if (!confirm("确定要导入吗？这将覆盖您现有的所有文章和设置！")){ return; }
		$.ajax({
			type: "POST", dataType: "json", contentType: "application/json; charset=utf-8",
			url: "/admin/import/", data: JSON.stringify($("#importForm").serializeArray()),
			success: function (result) {
				alert(result.msg);
				if(result.msg === "OK") { location.reload(); }
			},
			error: function() { alert("导入失败，请检查网络或登录状态。"); }
		});
	}

	function publish(){
		if (!confirm("确定吗?发布将清理所有静态缓存,重新生成")){ return; }
		$.ajax({
			type: "POST", dataType: "json", contentType: "application/json; charset=utf-8",
			url: "/admin/publish/",
			success: function (result) { alert(result.msg); },
			error: function() { alert("发布失败，请检查网络或登录状态。"); }
		});
	}

	function isJSON(str) {
		if (typeof str !== 'string') return false;
        if (str.trim() === '') return true;
		try {
			var obj = JSON.parse(str);
			return typeof obj == 'object' && obj;
		} catch (e) { return false; }
	}


	// ===== START: 已修改的评论JS =====
    function loadComments() {
		$.getJSON("/api/comments_all", function(comments) {
			var tbody = $('#comments-list').empty();
			$.each(comments, function(i, comment) {
				
				// --- 联系方式处理逻辑 ---
let contactInfo = '---'; // 默认值
if (comment.contact && comment.contact.value) {
    // 直接使用原始数据，不再通过 .text() 进行HTML转义
    const type = comment.contact.type || '未知';
    const value = comment.contact.value;

    // 直接拼接字符串，允许其中的 HTML 被渲染
    contactInfo = `${type}: ${value}`;
}			
				// --- 内容转义逻辑 ---
				const safeContent = $('<div>').text(comment.content).html();

				// --- 构建新的表格行 ---
				var row = `
					<tr id="comment-${comment.id}">
						<td><input type="checkbox" class="comment-checkbox" data-slug="${comment.articleSlug}" data-id="${comment.id}"></td>
						<td>${comment.articleSlug}</td>
						<td style="max-width: 300px; word-break: break-all;">${safeContent}</td>
						<td>${contactInfo}</td>
						<td>${new Date(comment.timestamp).toLocaleString()}</td>
						<td><button class="btn btn-danger btn-sm" onclick="deleteComment('${comment.articleSlug}', '${comment.id}')">删除</button></td>
					</tr>
				`;
				tbody.append(row);
			});
			// 重置全选框
			$('#select-all-comments').prop('checked', false);
		});
    }

    function deleteComment(articleSlug, commentId) {
        if (confirm('确定要删除这条评论吗？')) {
            $.ajax({ url: `/api/comments/${articleSlug}/${commentId}`, type: 'DELETE',
                success: function() { $(`#comment-${commentId}`).remove(); },
                error: function() { alert('删除失败'); }
            });
        }
    }

	// --- START: 新增批量删除逻辑 ---
	// 使用 $(document).on() 来确保动态加载的或隐藏的元素也能绑定事件
	
	// 1. 全选/取消全选 逻辑
	$(document).on('change', '#select-all-comments', function() {
		const isChecked = $(this).prop('checked');
		$('.comment-checkbox').prop('checked', isChecked);
	});

	// 2. 批量删除按钮 逻辑
	$(document).on('click', '#batch-delete-btn', async function() {
		const $selectedCheckboxes = $('.comment-checkbox:checked');
		
		if ($selectedCheckboxes.length === 0) {
			alert('请至少选择一条评论');
			return;
		}

		if (confirm(`确定要删除选中的 ${$selectedCheckboxes.length} 条评论吗？`)) {
			$(this).prop('disabled', true).text('删除中...');
			const deletePromises = [];
			
			$selectedCheckboxes.each(function() {
				const $checkbox = $(this);
				const slug = $checkbox.data('slug');
				const id = $checkbox.data('id');
				const $row = $(`#comment-${id}`);
				
				if (slug && id && $row.length > 0) {
					// 为每一次删除创建一个 promise (使用$.ajax)
					const deletePromise = $.ajax({ 
						url: `/api/comments/${slug}/${id}`, 
						type: 'DELETE' 
					}).then(function() {
						return $row; // 成功时，返回$row
					}).catch(function() {
						return Promise.reject($row); // 失败时，也返回$row
					});
					deletePromises.push(deletePromise);
				}
			});

			// 等待所有删除请求完成
			const results = await Promise.allSettled(deletePromises);

			let successCount = 0;
			let failureCount = 0;

			results.forEach(result => {
				if (result.status === 'fulfilled') {
					// 如果请求成功，从 DOM 中移除对应的行
					result.value.remove(); // result.value is $row
					successCount++;
				} else {
					// 如果请求失败，result.reason 就是 $row
					result.reason.css('backgroundColor', '#f8d7da'); // 标红
					failureCount++;
				}
			});

			alert(`批量删除完成：\n成功 ${successCount} 条\n失败 ${failureCount} 条`);
			
			// 取消全选
			$('#select-all-comments').prop('checked', false);
			$(this).prop('disabled', false).html('<i class="fas fa-trash"></i> 删除选中');
		}
	});
	// --- END: 新增批量删除逻辑 ---
	// ===== END: 已修改的评论JS =====


    function loadCarousel() {
		$.getJSON("/api/carousel", function(slides) {
			var tbody = $('#carousel-list').empty();
			$.each(slides, function(i, slide) {
				var row = `<tr id="slide-${slide.id}"><td><img src="${slide.imageUrl}" alt="预览" style="max-width: 150px; height: auto;"></td><td>${slide.imageUrl}</td><td>${slide.linkUrl}</td><td><button class="btn btn-danger btn-sm" onclick="deleteCarousel('${slide.id}')">删除</button></td></tr>`;
				tbody.append(row);
			});
		});
    }

    function addCarousel() {
        var imageUrl = $('#imageUrl').val();
        var linkUrl = $('#linkUrl').val();
        if (!imageUrl || !linkUrl) { alert('图片URL和链接URL均不能为空！'); return; }
        $.ajax({
            url: "/api/carousel", type: 'POST', contentType: "application/json",
            data: JSON.stringify({ imageUrl: imageUrl, linkUrl: linkUrl }),
            success: function() {
                loadCarousel();
                $('#imageUrl').val(''); $('#linkUrl').val('');
            },
            error: function() { alert('添加失败'); }
        });
    }

    function deleteCarousel(slideId) {
        if (confirm('确定要删除这张轮播图吗？')) {
            $.ajax({ url: `/api/carousel/${slideId}`, type: 'DELETE',
                success: function() { $(`#slide-${slideId}`).remove(); },
                error: function() { alert('删除失败'); }
            });
        }
    }
    
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      if(e.target.hash == "#comments-manager"){ loadComments(); }
      if(e.target.hash == "#carousel-manager"){ loadCarousel(); }
    });
</script>

</body>
</html>
