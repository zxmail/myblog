<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-g">
	<title>CF-blog后台</title>
	<link rel="icon" type="image/x-icon" href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon" href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico"/>
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.css">
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.css">
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/files/fonts/fontawesome5pro-all.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/files/tinymce/skins/ui/oxide/skin.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/admin/files/style.css">
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/jquery.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.js"></script>
	<script src="{{ &OPT.theme_github_path }}JustNews/admin/files/defaults-zh_CN.min.js"></script>
</head>
<body>

<div id="login-wrapper" style="display: none;">
    <div class="login-container">
        <div class="login-header">
            {{ #OPT.logo }}
                <img src="{{ &OPT.logo }}" alt="Logo">
            {{ /OPT.logo }}
            {{ ^OPT.logo }}
                {{ #OPT.siteName }}
                    <h1>{{ &OPT.siteName }}</h1>
                {{ /OPT.siteName }}
                {{ ^OPT.siteName }}
                    <h1>后台登录</h1>
                {{ /OPT.siteName }}
            {{ /OPT.logo }}
        </div>
        <form class="login-form" id="login-form">
            <div class="form-group">
                <input type="password" id="admin-password" class="form-control" placeholder="请输入密码" required>
            </div>
            <button type="submit" class="btn btn-primary btn-login">登录</button>
        </form>
        <div class="footer-link">
            <a href="/">&larr; 返回到博客首页</a>
        </div>
    </div>
</div>


<div id="admin-container" class="admin-container">
	<div class="admin-sidebar">
		<div class="sidebar-header">
			<a href="/" >CF-blog</a>
		</div>
		<ul class="nav nav-pills nav-stacked">
			<li class="active"><a data-toggle="tab" href="#list"><i class="fas fa-fw fa-list-alt"></i> 我的文章</a></li>
			<li><a data-toggle="tab" href="#new"><i class="fas fa-fw fa-plus"></i> 新建/编辑</a></li>
			<li><a data-toggle="tab" href="#category-menu"><i class="fas fa-fw fa-sitemap"></i> 分类/菜单</a></li>
			<li><a data-toggle="tab" href="#site-config"><i class="fas fa-fw fa-cog"></i> 网站设置</a></li>
			<li><a data-toggle="tab" href="#comments-manager"><i class="fas fa-fw fa-comments"></i> 评论管理</a></li>
			<li><a data-toggle="tab" href="#carousel-manager"><i class="fas fa-fw fa-images"></i> 轮播管理</a></li>
			<li><a data-toggle="tab" href="#pub"><i class="fas fa-fw fa-paper-plane"></i> 发布全站</a></li>
			<li><a href="#" id="logout-button"><i class="fas fa-fw fa-sign-out-alt"></i> 退出登录</a></li>
		</ul>
	</div>


	<div class="admin-content">
		<div class="tab-content">
			<div class="tab-pane fade in active" id="list">
				<div class="container-fluid">
					<h3>我的文章</h3>
					<table class="table table-striped" id="articleList">
						<thead>
							<tr>
								<th>ID</th>
								<th>标题</th>
								<th>创建日期</th>
                                <th>分类</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
					<input type="hidden" name="page" id="page" value='1'>
					<a id="loadmore" class="btn btn-default">加载更多...</a>
				</div>
			</div>


			<div class="tab-pane fade" id="new">
				<div class="container-fluid">
					<h3 id="labelNew">新增文章 <span style="color: red;">*</span></h3>
					<form id="addNewForm" class="form-inline" >
						<div class="form-group" style="width: 98%">
							<input type="hidden" class="form-control" name="id" id="id" >
							<input type="text" class="form-control" name="title" id="title" placeholder="标题" style="width: 100%;" required="true">
						</div>
						<div class="form-group">
							<label>特色图片</label>
							<input type="url" class="form-control" style="width: 400px;"  name="img" id="img" placeholder="图片URL" >
						</div>
						<div class="form-group">
							<label>永久链接</label>
							<input type="text" class="form-control" name="link" id="link" placeholder="英文或拼音" required="true">
						</div>
						<div class="form-group">
							<label>创建日期<span style="color: red;">*</span></label>
							<input type="datetime-local" class="form-control" id="createDate" name="createDate" placeholder=""  required="true">
						</div>
						<div class="form-group">
							<label>分类<span style="color: red;">*</span></label>
							<select class="selectpicker" multiple name="category[]" id="category">
							</select>
						</div>
						<div class="form-group">
							<label>标签</label>
							<input type="text" class="form-control" name="tags" id="tags" placeholder="标签1,标签2">
						</div>
						<div class="form-group">
							<label>权重</label>
							<input type="text" class="form-control" name="priority" id="priority" value='0.5' placeholder="0.1 - 1.0">
						</div>
						<div class="form-group">
							<label>更新频率</label>
								<select class="form-control" id="changefreq" name="changefreq">
								<option value="daily" selected  = "selected" >daily</option>
								<option value="hourly" >hourly</option>
								<option value="weekly" >weekly</option>
								<option value="monthly" >monthly</option>
								<option value="yearly" >yearly</option>
								<option value="never" >never</option>
								<option value="always" >always</option>
								</select>
						</div>

						<div class="form-group">
							<label>是否置顶</label>
							<select class="form-control" id="isPinned" name="isPinned">
								<option value="false" selected="selected">否</option>
								<option value="true">是</option>
							</select>
						</div>
						<div class="form-group">
							<label>文章密码</label>
							<input type="text" class="form-control" name="password" id="password" placeholder="留空则不加密">
						</div>
						<div class="form-group">
							<label>浏览量</label>
							<input type="number" class="form-control" name="views" id="views" value='0' placeholder="文章浏览量" style="width: 100px;">
						</div>
						<a  tabindex="0"  role="button"  type="submit" id="btn_saveAddNew" class="btn btn-primary" onclick="saveAddNew()">保存文章</a>
						<textarea id="content" name="content"></textarea>
					</form>
				</div>
			</div>

			<div class="tab-pane fade" id="category-menu">
				</div>
			
			<div class="tab-pane fade" id="site-config">
				</div>

			<div class="tab-pane fade" id="comments-manager">
				</div>
			<div class="tab-pane fade" id="carousel-manager">
				</div>
			
			<div class="tab-pane fade" id="pub">
				</div>
		</div>
	</div>
</div>

<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/tinymce.min.js"></script>
<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/langs/zh_CN.js"></script>
<script type="text/javascript">
	$(function() {
        // ... [登录、登出、检查状态逻辑保持不变] ...
        const loginWrapper = document.getElementById('login-wrapper');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('admin-password');
        const logoutButton = document.getElementById('logout-button');
        const adminContainer = document.getElementById('admin-container');

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            const enteredPassword = passwordInput.value;
			document.cookie = "password=" + enteredPassword + ";path=/";
			sessionStorage.setItem('isAdminLoggedIn', 'true');
			checkLoginStatus();
        });

        logoutButton.addEventListener('click', function(event) {
            event.preventDefault();
            sessionStorage.removeItem('isAdminLoggedIn');
            document.cookie = "password=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            passwordInput.value = '';
            checkLoginStatus();
        });

        function checkLoginStatus() {
             if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                loginWrapper.style.display = 'none';
                adminContainer.style.display = 'flex';
				loadInitialData();
            } else {
                loginWrapper.style.display = 'flex';
                adminContainer.style.display = 'none';
            }
        }
		
        checkLoginStatus();

		var isDataLoaded = false;
		function loadInitialData() {
			if (isDataLoaded) return;
			isDataLoaded = true;
			
			// ... [tinymce.init 和 loadInitialData 中的其他设置保持不变] ...
			tinymce.init({
				selector: '#content',
				language: 'zh_CN',
				height: 640,
				plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking save table directionality emoticons template paste',
				toolbar: 'insertfile undo redo | styleselect fontsizeselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons | code', // 在这里添加了 "code"
			});

			$('#createDate').val(new Date().toISOString().slice(0, 16));
			
			$('#siteName').val(`{{& OPT.siteName }}`);
			$('#logo').val(`{{& OPT.logo }}`);
			$('#site_description').val(`{{& site_description }}`);
			$('#site_keywords').val(`{{& site_keywords }}`);
			$('#site_footer_copyright').val(`{{& site_footer_copyright }}`);
			
			// ... [页脚链接、分类、菜单、友情链接加载逻辑保持不变] ...
			const footerLinksContainer = $('#footer-links-container');
			footerLinksContainer.empty();
			try {
                var tempDiv = $('<div>');
                tempDiv.html(`{{& footer_links }}`);
                var decodedJsonString = tempDiv.text();

				if (decodedJsonString.trim()) {
                    const footerLinks = JSON.parse(decodedJsonString);
                    if (footerLinks && Array.isArray(footerLinks)) {
                        footerLinks.forEach(link => {
                            const linkHtml = `
                                <div class="input-group" style="margin-top: 5px;">
                                    <span class="input-group-addon">图标</span>
                                    <input type="text" class="form-control" placeholder="例: fas fa-link" value="${link.icon || ''}">
                                    <span class="input-group-addon">名称</span>
                                    <input type="text" class="form-control" placeholder="链接名称" value="${link.text || ''}">
                                    <span class="input-group-addon">URL</span>
                                    <input type="text" class="form-control" placeholder="https://..." value="${link.url || ''}">
                                    <div class="input-group-btn">
                                        <button class="btn btn-danger remove-footer-link" type="button"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>`;
                            footerLinksContainer.append(linkHtml);
                        });
                    }
                }
			} catch(e) { 
                console.error("解析页脚链接失败:", e, "原始数据:", `{{& footer_links }}`);
            }

			var initialCategories = JSON.parse(`{{& widgetCategoryList }}`);
			var initialMenu = JSON.parse(`{{& widgetMenuList }}`);
			var initialLink = JSON.parse(`{{& widgetLinkList }}`);

			renderCategories(initialCategories);
			renderMenu(initialMenu, $('#menu-list'));

			if (initialLink && Array.isArray(initialLink)) {
                initialLink.forEach(function(link) {
                    if (link.type === 'image' || link.img) {
                        addLink('image', link);
                    } else {
                        addLink('text', link);
                    }
                });
            }
			
			updateCategoryDropdown(initialCategories);
			$("#loadmore").click();
		}

		function updateCategoryDropdown(categories) {
			var category_select = $('#category');
			category_select.empty();
			if (categories && categories.length > 0) {
				$.each(categories, function(i, cat) {
					category_select.append('<option value="' + cat.name + '">' + cat.name + '</option>');
				});
			}
			category_select.selectpicker('refresh');
		}

        $('a[data-toggle="tab"][href="#new"]').on('click', function(e) {
            if (!$(e.target).closest('.admin-sidebar').length || !$('#new').hasClass('active')) {
                 resetForm();
            }
        });
	});

	function resetForm() {
		$('#addNewForm')[0].reset();
		$('#id').val('');
		$('#labelNew').text("新增文章 *");
		if (tinymce.get('content')) {
			tinymce.get('content').setContent('');
		}
		$('#category').selectpicker('val', []);
		$('#createDate').val(new Date().toISOString().slice(0, 16));
		
		// ========== START: 重置新增字段 ==========
		$('#isPinned').val('false');
		$('#password').val('');
		$('#views').val('0');
		// ========== END: 重置新增字段 ==========
	}

	// ... [loadmore 点击事件保持不变] ...
	$("#loadmore").click(function(){
		var page=$("#page").val();
		$.ajax({
			url:"/admin/getList/" + page + "/",
			type:'GET',
			dataType:"json",
			success:function(data){
				if(data && data.length > 0) {
					var tableContent="";
					$.each(data,function(i, Info){
						tableContent += `<tr id="article-row-${Info.id}">
							<td>${Info.id}</td>
							<td>${Info.title}</td>
							<td>${Info.createDate ? Info.createDate.replace("T"," ") : ''}</td>
                            <td>${Info['category[]'] ? Info['category[]'].join(', ') : ''}</td>
							<td>
								<button class="btn btn-primary btn-xs" onclick="editArticle('${Info.id}')">编辑</button>
								<button class="btn btn-danger btn-xs" onclick="deleteArticle('${Info.id}')">删除</button>
							</td>
						</tr>`;
					})
					$("#articleList tbody").append(tableContent);
					$("#page").val(++page);
				} else {
					$("#loadmore").text("没有更多了").prop("disabled", true);
				}
			}
		});
	})


	function editArticle(id) {
		$.ajax({
			url: "/admin/get/" + id,
			type: 'GET',
			dataType: "json",
			success: function(articleJson) {
				if (articleJson) {
					resetForm();
					$('#id').val(articleJson.id);
					$('#title').val(articleJson.title);
					$('#img').val(articleJson.img);
					$('#link').val(articleJson.link);
					$('#createDate').val(articleJson.createDate.replace(" ", "T"));
					$('#tags').val(articleJson.tags);
					$('#priority').val(articleJson.priority !== undefined ? articleJson.priority : '0.5');
					$('#changefreq').val(articleJson.changefreq !== undefined ? articleJson.changefreq : 'daily');
					
					if (tinymce.get('content')) {
						// 使用 articleJson.content (已在 index_plus.js 中修复)
						tinymce.get('content').setContent(articleJson.content || '');
					}

					$('#category').selectpicker('val', articleJson['category[]'] || []);
					
					// ========== START: 加载新增字段的值 ==========
					// 将布尔值 'true'/'false' 转换为字符串
					$('#isPinned').val(articleJson.isPinned ? 'true' : 'false'); 
					$('#password').val(articleJson.password || '');
					$('#views').val(articleJson.views || 0);
					// ========== END: 加载新增字段的值 ==========

					$('#labelNew').text("编辑文章: " + articleJson.id);
					$('a[data-toggle="tab"][href="#new"]').tab('show');
					
					window.scrollTo(0, 0);

				} else {
					alert("获取文章失败！");
				}
			},
			error: function() {
				alert("请求文章数据失败，请检查网络或登录状态。");
			}
		});
	}

	// ... [deleteArticle 保持不变] ...
	function deleteArticle(id) {
		if (confirm("确定要删除这篇文章吗？此操作不可恢复。")) {
			$.ajax({
				url: "/admin/delete/" + id,
				type: 'POST',
				dataType: "json",
				success: function(result) {
					if (result.msg === "OK") {
						alert("删除成功！");
						$('#article-row-' + id).remove();
					} else {
						alert("删除失败: " + result.msg);
					}
				},
				error: function() {
					alert("请求失败，请检查网络或登录状态。");
				}
			});
		}
	}


	function saveAddNew(){
		if($('#title').val() == "" || $('#createDate').val() == "" || !$('#category').val() || $('#category').val().length === 0){
			alert("标题、创建日期和分类为必填项！");
			return;
		}
		var postURL = ($('#id').val()) ? "/admin/saveEdit/" : "/admin/saveAddNew/";
		tinymce.triggerSave();
		
		// serializeArray() 会自动包含新增的 isPinned, password, views 字段
		// 无需修改此函数
		$.ajax({
			type: "POST", dataType: "json", url: postURL,
			contentType: "application/json; charset=utf-8",
			data: JSON.stringify($("#addNewForm").serializeArray()),
			success: function (result) {
				if(result && result.msg === "OK"){
					if (result.id){ $('#id').val(result.id); $('#labelNew').text("编辑文章: "+result.id); }
					alert("保存成功！");
				} else { alert("保存失败: " + (result ? result.msg : '未知错误')); }
			},
			error: function() { alert("请求失败，请检查网络或登录状态。"); }
		});
	}

	// ... [所有其他JS函数 (分类、菜单、网站设置、导入导出、评论、轮播等) 保持不变] ...
	
	// ... [renderCategories, addCategory, removeCategory, renderMenu, addMenuItem, removeMenuItem, getMenuItemsFromDom, saveCategoryMenuSettings, addLink, removeLink, add-footer-link, remove-footer-link, saveSiteSettings, importBlog, publish, isJSON, loadComments, deleteComment, 批量删除, loadCarousel, addCarousel, deleteCarousel, tab shown.bs.tab 逻辑] ...

</script>

</body>
</html>
