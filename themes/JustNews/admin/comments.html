<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>评论管理</title>
    <link rel="stylesheet" href="files/bootstrap.min.css">
    <link rel="stylesheet" href="files/style.css">
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            文章管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="comments.html">
                            评论管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="edit.html?id=new">
                            写文章
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">评论管理</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-danger" id="batch-delete-btn">
                        删除选中
                    </button>
                </div>
                </div>

            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-comments"></th>
                            <th>文章 Slug</th>
                            <th>评论内容</th>
                            <th>联系方式</th>
                            <th>评论时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="comments-list">
                        </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    // 页面加载时获取所有评论
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/comments_all') //
            .then(response => response.json())
            .then(comments => {
                const tbody = document.getElementById('comments-list');
                tbody.innerHTML = ''; // 清空
                comments.forEach(comment => {

                    // --- START: 联系方式处理逻辑 ---
let contactInfo = '---'; // 默认值
if (comment.contact && comment.contact.value) {
    // 直接使用原始数据，不再通过 .textContent 和 .innerHTML 进行HTML转义
    const type = comment.contact.type || '未知';
    const value = comment.contact.value;

    // 直接拼接字符串，允许其中的 HTML 被渲染
    contactInfo = `${type}: ${value}`;
}
                    // --- END: 联系方式处理逻辑 ---
                    
                    // --- START: 内容转义逻辑 ---
                    const contentDiv = document.createElement('div');
                    contentDiv.textContent = comment.content;
                    const safeContent = contentDiv.innerHTML;
                    // --- END: 内容转义逻辑 ---

                    const row = `
                        <tr id="comment-${comment.id}">
                            <td><input type="checkbox" class="comment-checkbox" data-slug="${comment.articleSlug}" data-id="${comment.id}"></td>
                            <td>${comment.articleSlug}</td>
                            <td style="max-width: 300px; word-break: break-all;">${safeContent}</td>
                            <td>${contactInfo}</td>
                            <td>${new Date(comment.timestamp).toLocaleString()}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteComment('${comment.articleSlug}', '${comment.id}')">删除</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    });

    // 删除评论的函数
    function deleteComment(articleSlug, commentId) {
        if (confirm('确定要删除这条评论吗？')) {
            fetch(`/api/comments/${articleSlug}/${commentId}`, { method: 'DELETE' }) //
                .then(response => {
                    if (response.ok) {
                        const row = document.getElementById(`comment-${commentId}`);
                        if(row) row.remove();
                    } else {
                        alert('删除失败');
                    }
                });
        }
    }

    // --- START: 新增批量删除逻辑 ---

    // 1. 全选/取消全选 逻辑
    document.getElementById('select-all-comments').addEventListener('change', function(e) {
        const isChecked = e.target.checked;
        document.querySelectorAll('.comment-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    // 2. 批量删除按钮 逻辑
    document.getElementById('batch-delete-btn').addEventListener('click', async function() {
        const selectedCheckboxes = document.querySelectorAll('.comment-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一条评论');
            return;
        }

        if (confirm(`确定要删除选中的 ${selectedCheckboxes.length} 条评论吗？`)) {
            const deletePromises = [];
            const rowsToRemove = [];

            selectedCheckboxes.forEach(checkbox => {
                const slug = checkbox.dataset.slug;
                const id = checkbox.dataset.id;
                const row = document.getElementById(`comment-${id}`);
                
                if (slug && id && row) {
                    // 为每一次删除创建一个 promise
                    const deletePromise = fetch(`/api/comments/${slug}/${id}`, { method: 'DELETE' }) //
                        .then(response => {
                            if (response.ok) {
                                // 如果成功，标记这一行以便后续移除
                                return row; 
                            } else {
                                // 如果失败，抛出错误
                                return Promise.reject(row);
                            }
                        });
                    deletePromises.push(deletePromise);
                }
            });

            // 等待所有删除请求完成
            const results = await Promise.allSettled(deletePromises);

            let successCount = 0;
            let failureCount = 0;

            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    // 如果请求成功，从 DOM 中移除对应的行
                    result.value.remove();
                    successCount++;
                } else {
                    // 如果请求失败，result.reason 就是那一行(row)，可以给它加个高亮提示
                    result.reason.style.backgroundColor = '#f8d7da'; // 标红
                    failureCount++;
                }
            });

            alert(`批量删除完成：\n成功 ${successCount} 条\n失败 ${failureCount} 条`);
            
            // 取消全选
            document.getElementById('select-all-comments').checked = false;
        }
    });
    // --- END: 新增批量删除逻辑 ---

</script>

</body>
</html>

